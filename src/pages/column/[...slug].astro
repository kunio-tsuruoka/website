---
import { Renderer, marked } from 'marked';
import { Header } from '../../components/header';
import Layout from '../../layouts/layout.astro';
import { type MicroCMSEnv, getColumn } from '../../lib/microcms';
import { type TocItem, slugify } from '../../lib/toc';

// SSR: リクエスト時にMicroCMSから取得
export const prerender = false;
const { slug } = Astro.params;
const columnId = slug as string;

// Cloudflare Pages SSR: ランタイム環境変数を取得
const runtime = (Astro.locals as { runtime?: { env?: MicroCMSEnv } }).runtime;
const env = runtime?.env;

// MicroCMSから記事を取得
const column = await getColumn(columnId, env);

if (!column) {
  return Astro.redirect('/404');
}

// 目次データを収集しながらHTMLを生成するカスタムレンダラー
const toc: TocItem[] = [];
const renderer = new Renderer();

renderer.heading = ({ text, depth }) => {
  // h2, h3のみ目次に追加
  if (depth === 2 || depth === 3) {
    const id = slugify(text);
    toc.push({ id, text, level: depth });
    return `<h${depth} id="${id}">${text}</h${depth}>`;
  }
  return `<h${depth}>${text}</h${depth}>`;
};

// チェックボックス記法を自動変換
renderer.listitem = ({ text, task, checked }) => {
  // GFMタスクリスト（- [ ] / - [x]）
  if (task) {
    const className = checked ? 'checkbox checked' : 'checkbox unchecked';
    const cleanText = text.replace(/<input[^>]*>/, '').trim();
    return `<li class="${className}">${cleanText}</li>\n`;
  }

  // MicroCMS形式: テキストが [ ] や [x] で始まる場合も変換
  const checkboxMatch = text.match(/^\s*\[([xX\s]?)\]\s*/);
  if (checkboxMatch) {
    const isChecked = checkboxMatch[1].toLowerCase() === 'x';
    const className = isChecked ? 'checkbox checked' : 'checkbox unchecked';
    const cleanText = text.replace(/^\s*\[[xX\s]?\]\s*/, '').trim();
    return `<li class="${className}">${cleanText}</li>\n`;
  }

  return `<li>${text}</li>\n`;
};

// Markedの設定
marked.setOptions({
  breaks: true,
  gfm: true,
});
marked.use({ renderer });

const htmlContent = marked(column.content || '') as string;
const frontmatter = {
  title: column.title,
  publishedAt: new Date(column.publishedAt).toLocaleDateString('ja-JP'),
};

// 関連記事（仮データ）
const relatedArticles = [
  {
    title: '「見積もりが当てにならない」を防ぐ正しい見積もりの見方',
    slug: 'how-to-read-estimates',
    category: 'avoid-failure',
  },
  {
    title: '要件定義で失敗しないための実践チェックリスト',
    slug: 'requirement-checklist',
    category: 'avoid-failure',
  },
  {
    title: '無料PoCで効果検証する方法',
    slug: 'fast-development/01-free-poc-guide',
    category: 'fast-development',
  },
];
---

<Layout title={`${frontmatter.title} | Beekle`}>
  <Header client:load />
  <main class="pt-20">
    {/* Breadcrumb */}
    <section class="py-6 bg-gray-50 border-b border-gray-200">
      <div class="container mx-auto px-6 md:px-8">
        <nav class="flex items-center gap-2 text-sm text-gray-600">
          <a href="/" class="hover:text-primary-500 transition-colors">ホーム</a>
          <span>/</span>
          <a href="/column" class="hover:text-primary-500 transition-colors">コラム</a>
          <span>/</span>
          <span class="text-gray-900">{frontmatter.title}</span>
        </nav>
      </div>
    </section>

    {/* Article Header */}
    <section class="py-12 md:py-16 bg-gradient-to-br from-primary-50 to-primary-100">
      <div class="container mx-auto px-6 md:px-8 max-w-4xl">
        {/* Meta Info */}
        <div class="flex flex-wrap items-center gap-3 mb-6">
          <span class="text-sm text-gray-600">{frontmatter.publishedAt}</span>
        </div>

        {/* Title */}
        <h1 class="text-3xl md:text-5xl font-bold text-gray-900 leading-tight">
          {frontmatter.title}
        </h1>
      </div>
    </section>

    {/* Table of Contents */}
    {toc.length > 0 && (
      <section class="py-8 bg-white border-b border-gray-100">
        <div class="container mx-auto px-6 md:px-12 max-w-3xl">
          <nav class="toc-container bg-gray-50 rounded-2xl p-6">
            <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
              目次
            </h2>
            <ul class="space-y-2">
              {toc.map((item) => (
                <li class={item.level === 3 ? 'ml-4' : ''}>
                  <a
                    href={`#${item.id}`}
                    class="text-gray-600 hover:text-primary-500 transition-colors text-sm block py-1"
                  >
                    {item.level === 3 && <span class="text-gray-400 mr-1">─</span>}
                    {item.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </div>
      </section>
    )}

    {/* Article Content */}
    <article class="py-16 md:py-24 bg-white">
      <div class="container mx-auto px-6 md:px-12 max-w-3xl">
        <div class="markdown-content">
          <Fragment set:html={htmlContent} />
        </div>
      </div>
    </article>

    {/* Back to Column List */}
    <section class="py-16 bg-white">
      <div class="container mx-auto px-6 md:px-8 max-w-4xl">
        <a
          href="/column"
          class="inline-flex items-center text-primary-500 hover:text-primary-600 font-semibold transition-colors group"
        >
          <svg class="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span>コラム一覧に戻る</span>
        </a>
      </div>
    </section>

    {/* CTA Section */}
    <section class="py-20 bg-primary-500">
      <div class="container mx-auto px-6 md:px-8 max-w-4xl text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-white mb-6">
          この知識を実践してみませんか？
        </h2>
        <p class="text-xl text-white/90 mb-10">
          ゼロスタートなら、初期費用0円で動くプロトタイプを体験できます。
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/prooffirst"
            class="inline-flex items-center justify-center px-10 py-5 text-xl font-semibold text-primary-500 bg-white rounded-full hover:bg-gray-100 transition-all shadow-xl hover:shadow-2xl"
          >
            ゼロスタートを詳しく見る
            <svg class="w-6 h-6 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
          </a>
          <a
            href="/contact"
            class="inline-flex items-center justify-center px-10 py-5 text-xl font-semibold text-white bg-transparent border-2 border-white rounded-full hover:bg-white hover:text-primary-500 transition-all"
          >
            無料相談を予約する
          </a>
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  /* マークダウンコンテンツのデザインシステム - Tailwind設定を使用 */
  .markdown-content {
    @apply text-gray-800 text-lg leading-loose;
  }

  /* 見出しスタイル - 明確な階層を作る */
  .markdown-content :global(h1) {
    @apply font-bold text-gray-900 text-3xl md:text-4xl mt-16 mb-6;
  }

  .markdown-content :global(h2) {
    @apply font-bold text-gray-900 text-2xl md:text-3xl mt-16 mb-6 pb-3 border-b-4 border-primary-400;
    scroll-margin-top: 6rem;
  }

  .markdown-content :global(h3) {
    @apply font-bold text-gray-900 text-xl md:text-2xl mt-12 mb-4 relative pl-5;
    scroll-margin-top: 6rem;
  }

  .markdown-content :global(h3)::before {
    content: '';
    @apply absolute left-0 w-1.5 bg-gradient-to-b from-primary-500 to-primary-600 rounded;
    top: 0.2em;
    height: 1.3em;
  }

  .markdown-content :global(h4) {
    @apply font-bold text-gray-800 text-lg md:text-xl mt-10 mb-4;
  }

  .markdown-content :global(h5) {
    @apply font-bold text-gray-800 text-base md:text-lg mt-8 mb-3;
  }

  /* 段落スタイル - 読みやすい行間と余白 */
  .markdown-content :global(p) {
    @apply text-gray-700 text-lg leading-loose mb-6;
  }

  /* リンクスタイル - 目立つがエレガント */
  .markdown-content :global(a) {
    @apply text-primary-500 font-medium no-underline;
    position: relative;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
  }

  .markdown-content :global(a):hover {
    @apply text-primary-600;
    border-bottom-color: currentColor;
  }

  .markdown-content :global(a)::after {
    content: '→';
    margin-left: 0.25rem;
    opacity: 0;
    transition: all 0.2s ease;
    display: inline-block;
  }

  .markdown-content :global(a):hover::after {
    opacity: 1;
    margin-left: 0.375rem;
  }

  /* 強調テキスト */
  .markdown-content :global(strong) {
    @apply font-bold text-primary-700;
    background: linear-gradient(180deg, transparent 60%, rgba(199, 210, 254, 0.4) 60%);
    padding: 0 0.2em;
  }

  .markdown-content :global(em) {
    @apply italic text-gray-700;
  }

  /* リストスタイル - 視覚的に明確 */
  .markdown-content :global(ul) {
    @apply my-6 pl-0 list-none;
  }

  .markdown-content :global(ul li) {
    @apply relative text-gray-700 text-lg leading-loose pl-6 mb-3;
  }

  .markdown-content :global(ul li):last-child {
    @apply mb-0;
  }

  .markdown-content :global(ul li)::before {
    content: '';
    @apply absolute left-1 rounded-full;
    top: 0.7em;
    width: 8px;
    height: 8px;
    background: linear-gradient(135deg, #3D4DB7, #3544a4);
    box-shadow: 0 0 0 3px rgba(61, 77, 183, 0.15);
  }

  /* チェックボックス（- [ ] / - [x] マークダウン記法） */
  .markdown-content :global(li.checkbox) {
    @apply relative text-gray-700 text-lg leading-loose pl-10 mb-3;
  }

  .markdown-content :global(li.checkbox)::before {
    content: none;
  }

  .markdown-content :global(li.checkbox.checked)::before {
    content: '';
    @apply absolute left-0 w-6 h-6 rounded-full;
    top: 0.35em;
    background: linear-gradient(135deg, #10B981, #059669);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
  }

  .markdown-content :global(li.checkbox.checked)::after {
    content: '';
    @apply absolute;
    left: 8px;
    top: 0.55em;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .markdown-content :global(li.checkbox.unchecked)::before {
    content: '';
    @apply absolute left-0 w-6 h-6 rounded border-2 border-gray-300 bg-white;
    top: 0.35em;
  }

  /* 番号付きリスト */
  .markdown-content :global(ol) {
    @apply my-6 pl-0 list-none;
    counter-reset: item;
  }

  .markdown-content :global(ol li) {
    @apply relative text-gray-700 text-lg leading-loose pl-12 mb-4;
    counter-increment: item;
  }

  .markdown-content :global(ol li):last-child {
    @apply mb-0;
  }

  .markdown-content :global(ol li)::before {
    content: counter(item);
    @apply absolute left-0 w-8 h-8 text-white rounded-full flex items-center justify-center font-bold text-sm;
    background: linear-gradient(135deg, #3D4DB7, #3544a4);
    top: 0.15em;
  }

  /* 引用ブロック */
  .markdown-content :global(blockquote) {
    @apply bg-gradient-to-r from-primary-50 to-primary-100 rounded-xl;
    margin-top: 40px;    /* 8 × 5 */
    margin-bottom: 40px; /* 8 × 5 */
    padding: 24px;       /* 8 × 3 */
    border-left: 4px solid #3D4DB7;
    font-style: italic;
    position: relative;
  }

  .markdown-content :global(blockquote)::before {
    content: '"';
    position: absolute;
    top: -8px;           /* 8 × -1 */
    left: 16px;          /* 8 × 2 */
    font-size: 4rem;
    color: rgba(61, 77, 183, 0.2);
    font-family: Georgia, serif;
    line-height: 1;
  }

  .markdown-content :global(blockquote p) {
    @apply text-gray-700 mb-0;
  }

  /* コードブロック */
  .markdown-content :global(code) {
    @apply bg-gray-100 text-primary-500 rounded;
    padding: 4px 8px;    /* 上下4px (0.5×8), 左右8px (1×8) */
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 14px;     /* 本文より少し小さく */
  }

  .markdown-content :global(pre) {
    @apply bg-gray-900 text-gray-100 rounded-xl overflow-x-auto shadow-lg;
    margin-top: 40px;    /* 8 × 5 */
    margin-bottom: 40px; /* 8 × 5 */
    padding: 24px;       /* 8 × 3 */
  }

  .markdown-content :global(pre code) {
    @apply bg-transparent text-gray-100;
    padding: 0;
  }

  /* テーブル */
  .markdown-content :global(table) {
    @apply w-full border-collapse rounded-lg overflow-hidden shadow-md;
    margin-top: 40px;    /* 8 × 5 */
    margin-bottom: 40px; /* 8 × 5 */
  }

  .markdown-content :global(thead) {
    @apply bg-gradient-to-r from-primary-500 to-primary-600;
  }

  .markdown-content :global(th) {
    @apply text-left text-white font-bold;
    padding: 16px;       /* 8 × 2 */
    font-size: 16px;
  }

  .markdown-content :global(td) {
    @apply border-t border-gray-200 text-gray-700;
    padding: 16px;       /* 8 × 2 */
    font-size: 16px;
    line-height: 1.5;
  }

  .markdown-content :global(tbody tr):hover {
    @apply bg-primary-50;
  }

  /* 画像 */
  .markdown-content :global(img) {
    @apply rounded-xl shadow-lg mx-auto;
    margin-top: 40px;    /* 8 × 5 */
    margin-bottom: 40px; /* 8 × 5 */
    max-width: 100%;
    height: auto;
  }

  /* 水平線 */
  .markdown-content :global(hr) {
    @apply border-0;
    margin-top: 64px;    /* 8 × 8 */
    margin-bottom: 64px; /* 8 × 8 */
    height: 1px;
    background: linear-gradient(90deg, transparent, #e0e7ff, transparent);
  }

  /* カスタムボックススタイル（もし使われていれば） */
  .markdown-content :global(div[style*="background"]) {
    @apply rounded-xl;
    padding: 24px;       /* 8 × 3 */
    margin-top: 32px;    /* 8 × 4 */
    margin-bottom: 32px; /* 8 × 4 */
  }

  /* CTAボタンスタイル */
  .markdown-content :global(a[href^="/prooffirst"]),
  .markdown-content :global(a[href^="/contact"]) {
    @apply inline-flex items-center bg-gradient-to-r from-primary-500 to-primary-600 text-white font-bold rounded-full no-underline;
    padding: 12px 24px;  /* 上下12px (1.5×8), 左右24px (3×8) */
    transition: all 0.3s ease;
    border-bottom: none;
  }

  .markdown-content :global(a[href^="/prooffirst"])::after,
  .markdown-content :global(a[href^="/contact"])::after {
    content: none;
  }

  .markdown-content :global(a[href^="/prooffirst"]:hover),
  .markdown-content :global(a[href^="/contact"]:hover) {
    @apply shadow-xl;
    transform: translateY(-2px);
  }
</style>
